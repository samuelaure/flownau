generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String          @id @default(cuid())
  name      String?
  email     String?         @unique
  password  String?
  image     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  accounts  SocialAccount[]
}

model SocialAccount {
  id           String        @id @default(cuid())
  userId       String
  platform     String        @default("instagram")
  platformId   String?
  username     String?
  profileImage String?
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  shortCode    String?
  assetsRoot   String?
  assets       Asset[]
  compositions Composition[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  templates    Template[]

  @@unique([platform, platformId])
}

model Asset {
  id               String         @id @default(cuid())
  accountId        String?
  templateId       String?
  type             String
  systemFilename   String
  originalFilename String
  r2Key            String
  url              String
  size             Int
  mimeType         String
  hash             String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  thumbnailUrl     String?
  account          SocialAccount? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  template         Template?      @relation(fields: [templateId], references: [id])
}

model Template {
  id               String         @id @default(cuid())
  name             String
  remotionId       String
  airtableTableId  String?
  config           Json?
  accountId        String?
  useAccountAssets Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  assetsRoot       String?
  assets           Asset[]
  renders          Render[]
  account          SocialAccount? @relation(fields: [accountId], references: [id])
}

model Render {
  id               String   @id @default(cuid())
  templateId       String
  status           String   @default("IDLE")
  progress         Float    @default(0)
  inputData        Json?
  r2Url            String?
  instagramMediaId String?
  instagramStatus  String?
  error            String?
  renderLog        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  template         Template @relation(fields: [templateId], references: [id])
}

model SystemSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Composition {
  id         String        @id @default(cuid())
  accountId  String
  prompt     String?
  schemaJson Json
  videoUrl   String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  account    SocialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
}
